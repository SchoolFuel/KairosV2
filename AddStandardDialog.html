<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    :root{ --bg:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb; --pill:#f1f5f9; --accent:#0f172a; --accent-weak:#374151; --radius:10px; }
    body{ margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); background:var(--bg); }
    .wrap{ padding:16px 18px 14px 18px; }
    h1{ margin:0 0 10px 0; font-size:20px; }
    .banner{ margin:8px 0 12px; padding:10px 12px; background:var(--pill); border:1px solid var(--line); border-radius:var(--radius); }
    .muted{ color:var(--muted); }
    .row{ display:flex; gap:10px; align-items:center; margin:10px 0; flex-wrap:wrap; }
    select,input[type="search"]{ padding:8px 10px; border:1px solid var(--line); border-radius:var(--radius); outline:none; background:#fff; }
    input[type="search"]{ min-width:260px; }
    button{ padding:8px 12px; border:1px solid var(--line); border-radius:var(--radius); background:var(--accent); color:#fff; cursor:pointer; }
    button.secondary{ background:#fff; color:#111; }
    button.ghost{ background:#fff; color:var(--accent-weak); }
    button[disabled]{ opacity:.5; cursor:not-allowed; }
    .chips{ display:flex; gap:6px; flex-wrap:wrap; margin:4px 0 0; }
    .chip{ background:var(--pill); border:1px solid var(--line); border-radius:999px; padding:2px 8px; font-size:12px; }
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    thead th{ position:sticky; top:0; background:#f8fafc; border-bottom:1px solid var(--line); padding:8px; text-align:left; }
    tbody td{ border-bottom:1px solid var(--line); padding:8px; vertical-align:top; }
    .col-pick{ width:56px; }
    .col-code{ width:160px; }
    .empty{ text-align:center; color:var(--muted); padding:24px 0; }
    #msg{ display:none; margin:8px 0 0; border:1px solid #fecaca; background:#fef2f2; color:#991b1b; padding:8px 10px; border-radius:10px; }
    .ok{ border-color:#a7f3d0 !important; background:#ecfdf5 !important; color:#065f46 !important; }
  </style>
</head>
<body>
  <div class="wrap">

    <div id="gateBanner" class="banner muted">
      Tip: click a <b>Gate Title</b> row in the “Gate Standard” sheet first.
    </div>

    <div id="msg">Select any Checklist first</div>

    <div class="row">
      <label>Subject: <select id="subject"></select></label>
      <label>Grade: <select id="grade"></select></label>
      <input id="q" type="search" placeholder="Search description or code…">
      <button id="searchBtn">Search</button>
      <button class="ghost" id="selectAllBtn">Select all (shown)</button>
      <button class="ghost" id="clearBtn">Clear</button>
      <button class="ghost" id="refreshGateBtn">Refresh gate</button>
      <div class="muted" style="margin-left:auto">Results: <span id="resultCount">0</span></div>
    </div>

    <div class="chips" id="chips"></div>

    <table>
      <thead>
        <tr>
          <th class="col-pick">Pick</th>
          <th class="col-code">Code</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="3" class="empty">No results yet.</td></tr>
      </tbody>
    </table>

    <div class="row" style="justify-content:space-between; margin-top:12px;">
      <div><b id="selCount">0</b> selected</div>
      <div>
        <button id="insertBtn" disabled>Insert under selected Checklist</button>
        <button class="secondary" onclick="google.script.host.close()">Close</button>
      </div>
    </div>
  </div>

  <!-- Context from Apps Script template (must come before main JS) -->




  <script>
    // ---- state ----
    let lastResults = [];
    let selected = new Map(); // index -> {code,id}
    let activeGateOK = false;

    // ---- utils ----
    const deb = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };
    const $ = id => document.getElementById(id);



    function setOptions(sel, values){
  sel.innerHTML = '';
  const opt = document.createElement('option');
  opt.value = '';              // empty => All
  opt.textContent = 'All';
  sel.appendChild(opt);

  (values || []).forEach(v => {
    const o = document.createElement('option');
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  });

  sel.value = '';              // select “All” by default
}



    function showGateError(){ const m=$('msg'); m.textContent='Select any Checklist first'; m.classList.remove('ok'); m.style.display='block'; }
    function showOk(text){ const m=$('msg'); m.textContent=text; m.classList.add('ok'); m.style.display='block'; }
    function clearMsg(){ $('msg').style.display='none'; $('msg').classList.remove('ok'); }

    // ---- render ----
    function renderRows(rows){
      const tb = $('tbody'); tb.innerHTML='';
      if (!rows || rows.length===0){
        tb.innerHTML = '<tr><td colspan="3" class="empty">No matches. Adjust filters or search.</td></tr>';
        $('resultCount').textContent = 0;
        updateSelected(); return;
      }
      $('resultCount').textContent = rows.length;
      rows.forEach((r,i)=>{
        const tr=document.createElement('tr');
        const td0=document.createElement('td'); const cb=document.createElement('input');
        cb.type='checkbox'; cb.checked=selected.has(i);
        cb.onchange=()=>{ cb.checked ? selected.set(i,{code:r.code,id:r.id}) : selected.delete(i); updateSelected(); };
        td0.appendChild(cb);
        const td1=document.createElement('td'); td1.textContent=r.code;
        const td2=document.createElement('td'); td2.textContent=r.description;
        tr.appendChild(td0); tr.appendChild(td1); tr.appendChild(td2); tb.appendChild(tr);
      });
      updateSelected();
    }

    function updateSelected(){
      $('selCount').textContent = selected.size;
      $('insertBtn').disabled = selected.size===0;
      const chips=$('chips'); chips.innerHTML='';
      [...selected.values()].slice(0,10).forEach(s=>{ const c=document.createElement('span'); c.className='chip'; c.textContent=s.code; chips.appendChild(c); });
      if (selected.size>10){ const more=document.createElement('span'); more.className='chip'; more.textContent=`+${selected.size-10} more`; chips.appendChild(more); }


    }

    // ---- actions ----
    function search(){
      const subject=$('subject').value;
      const grade=$('grade').value;
      const q=$('q').value;
      $('tbody').innerHTML='<tr><td colspan="3" class="empty">Searching…</td></tr>';
      google.script.run
        .withSuccessHandler(rows=>{ lastResults=rows||[]; selected.clear(); renderRows(lastResults); })
        .withFailureHandler(handleServerError) // ignore
        .GSD_searchStandards(subject, grade, q, 300);
    }
    const debouncedSearch = deb(search,300);

    function selectAllShown(){
      selected.clear();
      lastResults.forEach((r,i)=>selected.set(i,{code:r.code,id:r.id}));
      renderRows(lastResults);

    }

    function clearAll(){
      selected.clear();
      renderRows(lastResults);

    }

    function refreshGate(){
      google.script.run
        .withSuccessHandler(info=>{
          const banner=$('gateBanner');
          if (info && info.ok){
            activeGateOK = true;
            banner.innerHTML = `Inserting under <b>Gate ${info.gateNum}</b>: <i>${info.gateTitle}</i>`;
            banner.classList.remove('muted');
            clearMsg();
          } else {
            activeGateOK = false;
            banner.innerHTML = 'Tip: click a <b>Gate Title</b> row in the “Gate Standard” sheet first.';
            banner.classList.add('muted');
            showGateError();
          }
        })
        .withFailureHandler(()=>showGateError())
        .GSD_getActiveGateInfo();
    }

  function handleServerError(err){
    const msg = (err && err.message) ? String(err.message) : String(err);
    if (/Gate Title/.test(msg)) showGateError();
    else { const m=$('msg'); m.textContent = msg.replace(/^Error:\s*/,''); m.classList.remove('ok'); m.style.display='block'; }
  }
</script>

<!-- Context injection: FIRST script block -->
<script>
  window.context = <?!= JSON.stringify(context || {}) ?>;
  window.ctx = {
    gateId: String((window.context.gateId || "")).trim(),
    checklistTitle: String((window.context.checklistTitle || "")).trim(),
  };
</script>

<!-- Main logic: SEPARATE script block -->
<script>
  const ctx = window.ctx || { gateId: "", checklistTitle: "" };

   function insert(){
    if (selected.size === 0) { alert('Pick at least one standard.'); return; }
    if (!ctx.gateId || !ctx.checklistTitle) { alert('Missing gate/checklist'); return; }

    const arr = [...selected.values()].map(x => ({
      code: x.code,
      id: x.id,
      percent: Number(x.percent || 0),
    }));

    google.script.run
      .withSuccessHandler(() => {
        // server has saved to cache; close dialog
        google.script.host.close();
      })
      .withFailureHandler(err => alert((err && err.message) || String(err)))
      .STD_pushSelectionToSidebar(ctx, arr);  // returns {ok,count,key,ts}
  }

  // Wire after DOM is ready (or set onclick="insert()" on the button)
  window.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("insertBtn");
    if (btn) btn.onclick = insert;
  });
</script>

<script>
    // ---- wire ----
    $('searchBtn').onclick=search;
    $('selectAllBtn').onclick=selectAllShown;
    $('clearBtn').onclick=clearAll;
    $('refreshGateBtn').onclick=refreshGate;
    // $('insertBtn').onclick=insert; // Already assigned in DOMContentLoaded
    $('q').addEventListener('input',debouncedSearch);
    $('q').addEventListener('keydown',e=>{ if(e.key==='Enter') search(); });

    // ---- bootstrap ----
let _loaded = 0;
const _kick = () => { if (++_loaded === 2) search(); };

google.script.run
  .withSuccessHandler(vals => { setOptions($('subject'), vals); _kick(); })
  .GSD_getSubjects();

google.script.run
  .withSuccessHandler(vals => { setOptions($('grade'), vals); _kick(); })
  .GSD_getGrades();

// Optional: if you want an immediate “Searching…” state, you can set it here,
// but initial search will run automatically once both lists are ready.
refreshGate();

  </script>
</body>
</html>